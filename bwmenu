#!/bin/bash
# Rofi extension for BitWarden-cli

BW_HASH_FILE=~/.bwhash

JQ_URLS=".[] | select(has(\"login\")) | .login.uris[0].uri" # until [#37](https://github.com/bitwarden/cli/issues/37) is resolved
#JQ_URLS=".[] | select(has(\"login\")) | .login.uris | .[].uri" 
JQ_NAMES=".[].name"

check_files() {
  if ! [ -f $BW_HASH_FILE ]; then touch $BW_HASH_FILE; fi
}

unlock_bw() {

  mpw=`rofi -dmenu -p 'Master Password' -password` || exit $?;

  if [ -z "$mpw" ]; then exit 1; fi
  bw unlock "$mpw" | grep -e 'export.*=="' -o > $BW_HASH_FILE || exit $?;

  source $BW_HASH_FILE
}

show_rofi() {
  rofi -dmenu -p 'Password' -no-custom -i -mesg " <b>Alt+u</b>: Urls | <b>Alt+n</b>: Names " -kb-custom-1 Alt-u -kb-custom-2 Alt-n
}

open_menu() {
  # decide what to search on
    case $1 in
      10) jq="$JQ_URLS";;
      11|*) jq="$JQ_NAMES";;
    esac;


  # show the rofi menu
  items=`bw list items`
  if [ $? -gt 0 ]; then
    unlock_bw
    open_menu $1
    return;
  fi;

  getPass=`echo $items | jq -r "$jq" | show_rofi`
  exit=$?

  if [ $exit -eq 0 ]; then

    if [ -z "$getPass" ]; then exit 0; fi

    # retrieve the id for single response matching
    id=`bw list items --search "$getPass" | jq -r '.[0].id'`
    pass=`bw get password $id`

    notify-send "$getPass" "${pass:0:4}***"
    printf "%s" $pass | xclip -selection clipboard

  elif [ $exit -eq 1 ]; then
    exit 1;

  else
    open_menu $exit;
  fi;
       
}

# check if files are present
check_files
source $BW_HASH_FILE
open_menu
